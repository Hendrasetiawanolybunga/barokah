{% extends 'web/basis_web.html' %}

{% block title %}{{ produk.nama_produk }} - UD Barokah Jaya Beton{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'beranda_pelanggan' %}">Beranda</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'daftar_produk_web' %}">Produk</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ produk.nama_produk }}</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            {% if produk.foto_produk %}
                <img src="{{ produk.foto_produk.url }}" class="img-fluid rounded" alt="{{ produk.nama_produk }}">
            {% else %}
                <img src="https://placehold.co/500x400/90EE90/059212?text={{ produk.nama_produk|urlencode }}" class="img-fluid rounded" alt="{{ produk.nama_produk }}">
            {% endif %}
        </div>
        <div class="col-md-6">
            <h1>{{ produk.nama_produk }}</h1>
            <p class="lead">{{ produk.deskripsi_produk }}</p>
            
            <div class="product-details mt-4">
                <div class="row">
                    <div class="col-6">
                        <p><strong>Kategori:</strong> {{ produk.kategori.nama_kategori }}</p>
                        <p><strong>Stok:</strong> 
                            {% if produk.stok_produk > 0 %}
                                <span class="text-success">{{ produk.stok_produk }} tersedia</span>
                            {% else %}
                                <span class="text-danger">Habis</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-6">
                        <p class="fw-bold text-success fs-4">Rp {{ produk.harga_produk|floatformat:2 }}</p>
                    </div>
                </div>
                
                {% if produk.stok_produk > 0 %}
                <div class="mt-4">
                    <div class="row align-items-center">
                        <div class="col-4">
                            <label for="jumlah" class="form-label">Jumlah:</label>
                            <div class="input-group">
                                <button class="btn btn-outline-success" type="button" id="decreaseQty">-</button>
                                <input type="number" class="form-control text-center" id="jumlah" value="1" min="1" max="{{ produk.stok_produk }}">
                                <button class="btn btn-outline-success" type="button" id="increaseQty">+</button>
                            </div>
                        </div>
                        <div class="col-8">
                            <button class="btn btn-success w-100" id="addToCart" data-product-id="{{ produk.id }}">
                                <i class="bi bi-cart-plus me-2"></i>Tambah ke Keranjang
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="mt-4">
                    <button class="btn btn-secondary w-100" disabled>
                        <i class="bi bi-cart-x me-2"></i>Stok Habis
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="row mt-5">
        <div class="col-12">
            <h3>Deskripsi Lengkap</h3>
            <p>{{ produk.deskripsi_produk }}</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const qtyInput = document.getElementById('jumlah');
    const decreaseBtn = document.getElementById('decreaseQty');
    const increaseBtn = document.getElementById('increaseQty');
    const addToCartBtn = document.getElementById('addToCart');
    
    if (decreaseBtn && increaseBtn && qtyInput) {
        decreaseBtn.addEventListener('click', function() {
            let value = parseInt(qtyInput.value);
            if (value > 1) {
                qtyInput.value = value - 1;
            }
        });
        
        increaseBtn.addEventListener('click', function() {
            let value = parseInt(qtyInput.value);
            let max = parseInt(qtyInput.max);
            if (value < max) {
                qtyInput.value = value + 1;
            }
        });
        
        qtyInput.addEventListener('change', function() {
            let value = parseInt(qtyInput.value);
            let max = parseInt(qtyInput.max);
            if (value < 1) {
                qtyInput.value = 1;
            } else if (value > max) {
                qtyInput.value = max;
            }
        });
    }
    
    if (addToCartBtn) {
        addToCartBtn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const quantity = parseInt(qtyInput.value);
            
            // Send AJAX request
            fetch(`/web/add-to-cart/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update cart badge
                    const cartBadge = document.querySelector('.navbar .badge');
                    if (cartBadge) {
                        cartBadge.textContent = data.cart_count;
                    }
                    // Show success message
                    alert(data.message);
                } else {
                    alert('Gagal menambahkan ke keranjang');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menambahkan ke keranjang');
            });
        });
    }
});
</script>
{% endblock %}