{% extends 'core/basis.html' %}

{% block title %}Tambah Transaksi Baru - Barokah{% endblock %}

{% block page_title %}Tambah Transaksi Baru{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'daftar_transaksi' %}">Transaksi</a></li>
<li class="breadcrumb-item active">Tambah Transaksi</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Form Transaksi Baru</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.pelanggan.id_for_label }}" class="form-label">Pelanggan</label>
                            {{ form.pelanggan }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.status_transaksi.id_for_label }}" class="form-label">Status Transaksi</label>
                            {{ form.status_transaksi }}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.alamat_pengiriman.id_for_label }}" class="form-label">Alamat Pengiriman</label>
                            {{ form.alamat_pengiriman }}
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h5>Detail Produk</h5>
                <div id="produk-container">
                    <div class="produk-item mb-3">
                        <div class="row">
                            <div class="col-md-5">
                                <label class="form-label">Produk</label>
                                <select name="produk_0" class="form-control produk-select">
                                    <option value="">Pilih Produk</option>
                                    {% for produk in produk_list %}
                                        <option value="{{ produk.id }}" data-harga="{{ produk.harga_produk }}">{{ produk.nama_produk }} - Rp {{ produk.harga_produk|floatformat:2 }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Jumlah</label>
                                <input type="number" name="jumlah_produk_0" class="form-control jumlah-input" min="1" value="1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Sub Total</label>
                                <input type="number" class="form-control sub-total" step="0.01" value="0" readonly>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">Aksi</label>
                                <button type="button" class="btn btn-danger btn-sm remove-produk w-100">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" id="tambah-produk" class="btn btn-outline-dark mb-3">
                    <i class="bi bi-plus-circle me-1"></i> Tambah Produk
                </button>
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'daftar_transaksi' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Kembali
                    </a>
                    <button type="submit" class="btn btn-dark">
                        <i class="bi bi-save"></i> Simpan Transaksi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let counter = 1; // Counter for unique IDs
    
    // Function to calculate sub total
    function calculateSubTotal(selectElement) {
        const produkItem = selectElement.closest('.produk-item');
        const harga = parseFloat(selectElement.selectedOptions[0]?.dataset.harga) || 0;
        const jumlah = parseInt(produkItem.querySelector('.jumlah-input').value) || 0;
        const subTotal = harga * jumlah;
        produkItem.querySelector('.sub-total').value = subTotal.toFixed(2);
    }
    
    // Function to update all sub totals
    function updateAllSubTotals() {
        document.querySelectorAll('.produk-select').forEach(function(select) {
            calculateSubTotal(select);
        });
    }
    
    // Event listener for produk select
    document.getElementById('produk-container').addEventListener('change', function(e) {
        if (e.target.classList.contains('produk-select')) {
            calculateSubTotal(e.target);
        }
    });
    
    // Event listener for jumlah input
    document.getElementById('produk-container').addEventListener('input', function(e) {
        if (e.target.classList.contains('jumlah-input')) {
            const select = e.target.closest('.produk-item').querySelector('.produk-select');
            calculateSubTotal(select);
        }
    });
    
    // Tambah produk baru
    document.getElementById('tambah-produk').addEventListener('click', function() {
        const container = document.getElementById('produk-container');
        const produkItem = document.querySelector('.produk-item').cloneNode(true);
        
        // Reset nilai input
        const selects = produkItem.querySelectorAll('select');
        const inputs = produkItem.querySelectorAll('input');
        selects[0].selectedIndex = 0;
        inputs[0].value = 1;
        inputs[1].value = 0;
        
        // Set unique names and IDs
        selects[0].name = 'produk_' + counter;
        inputs[0].name = 'jumlah_produk_' + counter;
        counter++;
        
        container.appendChild(produkItem);
    });
    
    // Hapus produk
    document.getElementById('produk-container').addEventListener('click', function(e) {
        if (e.target.closest('.remove-produk')) {
            const item = e.target.closest('.produk-item');
            if (document.querySelectorAll('.produk-item').length > 1) {
                item.remove();
            } else {
                alert('Minimal harus ada satu produk.');
            }
        }
    });
    
    // Initialize sub totals
    updateAllSubTotals();
});
</script>
{% endblock %}