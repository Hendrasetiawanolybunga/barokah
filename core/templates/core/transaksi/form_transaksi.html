{% extends 'core/basis.html' %}

{% block title %}{{ title }} - Barokah{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'daftar_transaksi' %}">Transaksi</a></li>
<li class="breadcrumb-item active">{{ title }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">{{ title }}</h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.pelanggan.id_for_label }}" class="form-label">Pelanggan</label>
                            {{ form.pelanggan }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.tanggal.id_for_label }}" class="form-label">Tanggal</label>
                            {{ form.tanggal }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.batas_waktu_bayar.id_for_label }}" class="form-label">Batas Waktu Bayar</label>
                            {{ form.batas_waktu_bayar }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.status_transaksi.id_for_label }}" class="form-label">Status Transaksi</label>
                            {{ form.status_transaksi }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.ongkir.id_for_label }}" class="form-label">Ongkir</label>
                            {{ form.ongkir }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.total_diskon.id_for_label }}" class="form-label">Total Diskon</label>
                            {{ form.total_diskon }}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.total.id_for_label }}" class="form-label">Total</label>
                            {{ form.total }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.bukti_bayar.id_for_label }}" class="form-label">Bukti Bayar</label>
                            {{ form.bukti_bayar }}
                            {% if transaksi.bukti_bayar %}
                                <div class="mt-2">
                                    <a href="{{ transaksi.bukti_bayar.url }}" target="_blank">Lihat Bukti Bayar</a>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.keterangan_diskon.id_for_label }}" class="form-label">Keterangan Diskon</label>
                            {{ form.keterangan_diskon }}
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.alamat_pengiriman.id_for_label }}" class="form-label">Alamat Pengiriman</label>
                    {{ form.alamat_pengiriman }}
                </div>
                
                <hr>
                
                <h5>Detail Produk</h5>
                <div id="detail-container">
                    {% for detail in detail_transaksi_list %}
                    <div class="detail-item mb-3">
                        <div class="row">
                            <div class="col-md-5">
                                <label class="form-label">Produk</label>
                                <select name="produk_{{ detail.id }}" class="form-control">
                                    <option value="">Pilih Produk</option>
                                    {% for produk in produk_list %}
                                        <option value="{{ produk.id }}" {% if detail.produk.id == produk.id %}selected{% endif %}>
                                            {{ produk.nama_produk }} - Rp {{ produk.harga_produk|floatformat:2 }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Jumlah</label>
                                <input type="number" name="jumlah_{{ detail.id }}" class="form-control" min="1" value="{{ detail.jumlah_produk }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Sub Total</label>
                                <input type="number" name="subtotal_{{ detail.id }}" class="form-control" step="0.01" value="{{ detail.sub_total }}">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">Aksi</label>
                                <button type="button" class="btn btn-danger btn-sm remove-detail w-100">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <button type="button" id="tambah-detail" class="btn btn-outline-dark mb-3">
                    <i class="bi bi-plus-circle me-1"></i> Tambah Detail
                </button>
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'daftar_transaksi' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Kembali
                    </a>
                    <button type="submit" class="btn btn-dark">
                        <i class="bi bi-save"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tambah detail baru
    document.getElementById('tambah-detail').addEventListener('click', function() {
        const container = document.getElementById('detail-container');
        const detailCount = document.querySelectorAll('.detail-item').length;
        const detailItem = document.createElement('div');
        detailItem.className = 'detail-item mb-3';
        detailItem.innerHTML = `
            <div class="row">
                <div class="col-md-5">
                    <label class="form-label">Produk</label>
                    <select name="produk_new_${detailCount}" class="form-control">
                        <option value="">Pilih Produk</option>
                        {% for produk in produk_list %}
                            <option value="{{ produk.id }}">{{ produk.nama_produk }} - Rp {{ produk.harga_produk|floatformat:2 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Jumlah</label>
                    <input type="number" name="jumlah_new_${detailCount}" class="form-control" min="1" value="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sub Total</label>
                    <input type="number" name="subtotal_new_${detailCount}" class="form-control" step="0.01" value="0">
                </div>
                <div class="col-md-1">
                    <label class="form-label">Aksi</label>
                    <button type="button" class="btn btn-danger btn-sm remove-detail w-100">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(detailItem);
    });
    
    // Hapus detail
    document.getElementById('detail-container').addEventListener('click', function(e) {
        if (e.target.closest('.remove-detail')) {
            const item = e.target.closest('.detail-item');
            if (document.querySelectorAll('.detail-item').length > 1) {
                item.remove();
            } else {
                alert('Minimal harus ada satu detail.');
            }
        }
    });
});
</script>
{% endblock %}